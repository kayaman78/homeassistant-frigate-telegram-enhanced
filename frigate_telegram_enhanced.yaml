blueprint:
  name: Frigate - Telegram Notification Enhanced v1.0
  description: Create automations to receive Snapshots and Clips from Frigate
  domain: automation
  input:
    camera:
      name: Frigate Camera
      description: The name of the camera as defined in your frigate configuration (/conf.yml).
    target_chat:
      name: Target
      description: 'The chat_id to be used by the Telegram bot. 
                !secret chat_id is not allowed on Blueprint, you will need the chat_id code.
        '
    notification:
      name: Notification
      description: 'Select "true" to disable notification, lave "false" to receive
        notification.
        '
      selector:
        select:
          options:
          - 'true'
          - 'false'
      default: 'false'
    base_url:
      name: (Optional) Base URL
      description: The external url for your Home Assistant instance. This will default
        to a relative URL and will open the clips in the app instead of the browser,
        which may cause issues on some devices.
      default: ''
    frigate_url:
      name: (Optional) Frigate URL
      description: The external URL for your Frigate instance (e.g., https://frigate.yourdomain.com). If provided, adds a button to open Frigate camera view.
      default: ''
    zone_filter:
      name: (Optional) Zone Filter
      description: Only notify if object has entered a defined zone.
      default: false
      selector:
        boolean: {}
    zones:
      name: (Optional) Trigger Zones
      description: A list (-) of zones you wish to recieve notifications for.
      default: []
      selector:
        object: {}
    labels:
      name: (Optional) Trigger Objects
      description: A list (-) of objects you wish to recieve notifications for.
      default: []
      selector:
        object: {}
    presence_filter:
      name: (Optional) Presence Filter
      description: Select one or more person/device_tracker entities. Notifications will be sent only when ALL selected entities are away from home.
      default: []
      selector:
        entity:
          multiple: true
          filter:
            - domain: person
            - domain: device_tracker
    notification_mode:
      name: Notification Mode
      description: Select when to receive notifications
      default: always_active
      selector:
        select:
          options:
            - label: Disabled
              value: disabled
            - label: Away only
              value: away_only
            - label: Night only
              value: night_only
            - label: Day only
              value: day_only
            - label: Away + Night
              value: away_and_night
            - label: After hours
              value: after_hours
            - label: Always active
              value: always_active
    work_start_time:
      name: (Optional) Work Start Time
      description: Start time of business hours (used only with "After hours" mode). Format HH:MM
      default: '07:00'
    work_end_time:
      name: (Optional) Work End Time
      description: End time of business hours (used only with "After hours" mode). Format HH:MM
      default: '19:00'
    workday_sensor:
      name: (Optional) Workday Sensor
      description: Binary sensor for workday detection (used only with "After hours" mode). Create with workday integration.
      default: ''
      selector:
        entity:
          domain: binary_sensor
    post_event_action:
      name: (Optional) Post-Event Action
      description: Optional actions to run when object is detected (e.g., turn on lights, trigger alarm, etc.). Leave empty for no action.
      default: []
      selector:
        action: {}
mode: single
max_exceeded: silent
trigger:
  platform: mqtt
  topic: frigate/events
  payload: !input 'camera'
  value_template: '{{ value_json[''after''][''camera''] }}'
variables:
  id: '{{ trigger.payload_json[''after''][''id''] }}'
  camera: '{{ trigger.payload_json[''after''][''camera''] }}'
  camera_name: '{{ camera | replace(''_'', '' '') | title }}'
  target_chat: !input 'target_chat'
  object: '{{ trigger.payload_json[''after''][''label''] }}'
  label: '{{ object | title }}'
  entered_zones: '{{ trigger.payload_json[''after''][''entered_zones''] }}'
  type: '{{ trigger.payload_json[''type''] }}'
  base_url: !input 'base_url'
  frigate_url: !input 'frigate_url'
  zone_only: !input 'zone_filter'
  input_zones: !input 'zones'
  zones: '{{ input_zones | list }}'
  input_labels: !input 'labels'
  labels: '{{ input_labels | list }}'
  presence_entities: !input 'presence_filter'
  notification: !input 'notification'
  notification_mode: !input 'notification_mode'
  work_start: !input 'work_start_time'
  work_end: !input 'work_end_time'
  workday_entity: !input 'workday_sensor'
  is_night: '{{ state_attr(''sun.sun'', ''elevation'') < 0 }}'
  anyone_home: >-
    {% if presence_entities | length == 0 %}
      false
    {% else %}
      {{ presence_entities | select('is_state', 'home') | list | length > 0 }}
    {% endif %}
  current_time: '{{ now().strftime("%H:%M") }}'
  is_workday: '{{ workday_entity and is_state(workday_entity, ''on'') }}'
  is_business_hours: >-
    {% if not workday_entity %}
      false
    {% else %}
      {{ is_workday and work_start <= current_time < work_end }}
    {% endif %}
  emoji: >-
    {% if object == 'person' %}
      ðŸ‘¤
    {% elif object == 'car' %}
      ðŸš—
    {% else %}
      ðŸš¨
    {% endif %}
  object_label: >-
    {% if object == 'person' %}
      Person detected
    {% elif object == 'car' %}
      Car detected
    {% else %}
      Motion detected
    {% endif %}
condition:
- '{{ type != ''end'' }}'
- '{{ not zone_only or entered_zones|length > 0 }}'
- '{{ not zones|length or zones|select(''in'', entered_zones)|list|length > 0 }}'
- '{{ not labels|length or object in labels }}'
- >-
  {{
    notification_mode == 'always_active' or
    (notification_mode == 'disabled' and false) or
    (notification_mode == 'away_only' and not anyone_home) or
    (notification_mode == 'night_only' and is_night) or
    (notification_mode == 'day_only' and not is_night) or
    (notification_mode == 'away_and_night' and (not anyone_home or is_night)) or
    (notification_mode == 'after_hours' and not is_business_hours)
  }}
action:
- service: telegram_bot.send_photo
  response_variable: first_message
  data:
    target: '{{ target_chat }}'
    disable_notification: '{{ notification }}'
    caption: |
      {{ emoji }} {{ object_label }}
      ðŸ“¹ {{ camera_name }}
      ðŸ• {{ now().strftime('%H:%M:%S') }}
    url: >-
      {% if base_url %}
        {{base_url}}/api/frigate/notifications/{{id}}/snapshot.jpg?bbox=1
      {% else %}
        {{ states.sensor.external_url.state if states.sensor.external_url else 'http://' + states('sensor.local_ip') + ':8123' }}/api/frigate/notifications/{{id}}/snapshot.jpg?bbox=1
      {% endif %}
- repeat:
    sequence:
    - wait_for_trigger:
      - platform: mqtt
        topic: frigate/events
        payload: '{{ id }}'
        value_template: '{{ value_json[''after''][''id''] }}'
      timeout:
        minutes: 2
      continue_on_timeout: false
    - condition: template
      value_template: '{{ wait.trigger.payload_json[''type''] == ''end'' }}'
    - service: telegram_bot.send_video
      data:
        target: '{{ target_chat }}'
        disable_notification: '{{ notification }}'
        reply_to_message_id: '{{ first_message.chats[0].message_id }}'
        caption: |
          ðŸ“¹ {{ camera_name }} - Event Recording
          ðŸ• {{ now().strftime('%H:%M:%S') }}
        url: >-
          {% if base_url %}
            {{base_url}}/api/frigate/notifications/{{id}}/{{camera}}/clip.mp4
          {% else %}
            {{ states.sensor.external_url.state if states.sensor.external_url else 'http://' + states('sensor.local_ip') + ':8123' }}/api/frigate/notifications/{{id}}/{{camera}}/clip.mp4
          {% endif %}
    until: '{{ wait.trigger.payload_json[''type''] == ''end'' }}'
- choose: []
  default: !input 'post_event_action'